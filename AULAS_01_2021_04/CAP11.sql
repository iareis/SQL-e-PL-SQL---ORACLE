--------------------
-- CRIANDO VISÃ•ES --
--------------------
--visÃµes sÃ£o views

-- Ã© uma tabela lÃ³gica baseada em uma tabela ou outra visÃ£o. 
-- VIEW sÃ£o SELECTS salvas em forma de OBJETOS
-- podem ser SIMPLES e COMPLEXAS

-- CREATE OR REPLACE // FORCE OR NOFORCE // OR REPLACE (atualiza ou recria)

------------------------------------------------------------------------------

CREATE OR REPLACE VIEW V_ALUNO
AS 
    SELECT COD_ALUNO AS CODIGO, SALARIO, NOME AS ALUNO, ESTADO, CIDADE
    FROM TALUNO
    WHERE ESTADO = 'RS';

-- USANDO A VIEW
SELECT * FROM V_ALUNO
ORDER BY ALUNO;

---

CREATE OR REPLACE VIEW V_CONTRATO_TOP
AS  
    SELECT COD_CONTRATO, DESCONTO
    FROM TCONTRATO
    WHERE DESCONTO > 10;

SELECT * FROM V_CONTRATO_TOP;


-- PARA VISUALIZAR AS VIEWA EXISTENTES E CRIADAS PELO USUÃ?RIO EM VOGA... 
SELECT VIEW_NAME, TEXT
FROM USER_VIEWS;

-- VIEW COM PARÃ‚METROS DE SAÃ?DA
CREATE OR REPLACE VIEW V_ALUNO2 (COD, ALUNO, SAL)
AS
    SELECT COD_ALUNO, NOME, SALARIO
    FROM TALUNO;

SELECT * FROM V_ALUNO2
ORDER BY ALUNO;

-- VIEW COMPLEXA
CREATE OR REPLACE VIEW V_CONTRATO
AS
    SELECT  TRUNC(DATA) AS DATA,
            MAX(DESCONTO) MAXIMO,
            AVG(DESCONTO) MEDIA,
            COUNT(*) QTDE 
    FROM TCONTRATO
    GROUP BY TRUNC(DATA);

SELECT * FROM V_CONTRATO;

--VIEW SIMPLES
CREATE OR REPLACE VIEW V_PESSOA_F
AS
    SELECT COD_PESSOA, TIPO, NOME, COD_RUA AS RUA
    FROM TPESSOA
    WHERE TIPO = 'F';

SELECT * FROM V_PESSOA_F;

-- EXEMPLO DE CONSULTA USANDO VIEW JÃ? CRIADA E MAIS DE UMA TABELA
SELECT  PES.COD_PESSOA AS CODIGO,
        PES.NOME AS PESSOA,
        CID.NOME AS CIDADE,
        RUA.NOME AS RUA
FROM V_PESSOA_F PES, TRUA RUA, TCIDADE CID 
WHERE PES.RUA = RUA.COD_RUA(+)
AND CID.COD_CIDADE = RUA.COD_CIDADE
ORDER BY PES.NOME;

-- OPERAÃ‡ÃƒO DML NA VIEW
CREATE OR REPLACE VIEW VCURSOS1000CK
AS 
    SELECT COD_CURSO, NOME, VALOR
    FROM TCURSO
    WHERE VALOR = 1000
    WITH CHECK OPTION CONSTRAINT VCURSOS1000__CK;

INSERT INTO VCURSOS1000CK (COD_CURSO, NOME, VALOR)
VALUES (52, 'TESTE-y', 999);
/*
Erro a partir da linha : 87 no comando -
INSERT INTO VCURSOS1000CK (COD_CURSO, NOME, VALOR)
VALUES (52, 'TESTE-y', 999)
RelatÃ³rio de erros -
ORA-01402: violaÃ§Ã£o da clÃ¡usula where da view WITH CHECK OPTION

ERRO GERADO DEVIDO AO VALOR INSERIDO SER DIFERENTE DO VALOR DEFINIDO NA VIEW
*/

INSERT INTO VCURSOS1000CK (COD_CURSO, NOME, VALOR)
VALUES (52, 'TESTE-y', 1000);

SELECT * FROM TCURSO;

SELECT * FROM VCURSOS1000CK;

-- DELETE EM VIEW
SELECT * FROM V_ALUNO;

DELETE FROM V_ALUNO WHERE CODIGO = 3;

SELECT * FROM TALUNO;

-- INSERT EM VIEW
INSERT INTO V_ALUNO
VALUES (50,500,'RS','MYLLA', 'TORRES');
/*
Erro a partir da linha : 114 no comando -
INSERT INTO V_ALUNO
VALUES (50,500,'RS','MYLLA', 'TORRES')
RelatÃ³rio de erros -
ORA-12899: valor muito grande para a coluna "IAREIS"."TALUNO"."ESTADO" (real: 5, mÃ¡ximo: 2)

ERRO DEVIDO AO ESTADO SER A UF, ENTÃƒO APENAS 2 DÃ?GITOS
*/
SELECT * FROM V_ALUNO;

INSERT INTO V_ALUNO
VALUES (25,800,'MYLLA','RS','VACARIA');




COMMIT;

-- VAMOS FAZER UM DELETE EM UMA VIEW
-- (NÃƒO PODE FAZER DML EM VIEW COMPLEXA)
DELETE FROM V_CONTRATO;
/*
Erro a partir da linha : 137 no comando -
DELETE FROM V_CONTRATO
Erro na Linha de Comandos : 137 Coluna : 13
RelatÃ³rio de erros -
Erro de SQL: ORA-01732: operaÃ§Ã£o de tratamento de dados invÃ¡lida nesta view
01732. 00000 -  "data manipulation operation not legal on this view"
*Cause:    

ELA Ã‰ COMPLEXA. O SELECT DELA TEM FUNÃ‡Ã•ES DE GRUPO
*/

-- VIEW SOMENTE LEITURA (NÃƒO PERMITE DML)
CREATE OR REPLACE VIEW V_ALUNO3
AS 
    SELECT  COD_ALUNO CODIGO,
            NOME ALUNO, CIDADE
    FROM TALUNO
    WHERE ESTADO = 'RS'
    WITH READ ONLY;

-- nÃƒO PODE EXECUTAR DELETE EM VIEW SOMENTE PARA LEITURA
DELETE FROM V_ALUNO3;
/*
Erro de SQL: ORA-42399: nÃ£o Ã© possÃ­vel efetuar uma operaÃ§Ã£o de DML em uma view somente para leitura
*/  

-- EXCLUINDO UMA VISÃƒO --> VIEW
DROP VIEW V_ALUNO3;

